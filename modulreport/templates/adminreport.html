{% extends 'base.html' %}
{% load static %}

{% block meta %}
    <title>Admin Report</title>
{% endblock meta %}

{% block content %}
<style>
    .table th,
    .table td {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Mengatur lebar maksimum sesuai kebutuhan Anda */
    @media (max-width: 767px) {
        .table th,
        .table td {
            max-width: 100px; /* Atur sesuai kebutuhan Anda */
        }
    }

    @media (min-width: 768px) {
        .table th,
        .table td {
            max-width: 200px; /* Atur sesuai kebutuhan Anda */
        }
    }
</style>

<div class="container">
    <h1>Admin Report</h1>
    <div class="input-group mb-3">
        <input type="text" id="searchByTitle" class="form-control" placeholder="Search by Judul Buku" />
        <button class="btn btn-primary" id="searchButton" type="button">Search</button>
    </div>
    <div id="noReportsMessage" style="display: none;">Daftar Laporan Kosong.</div>
    <!-- Tabel untuk menampilkan laporan -->
    <table class="table table-striped">
        <thead>
            <tr>
                <th>User</th>
                <th>Status</th>
                <th>Judul Buku</th>
                <th>Jenis Masalah</th>
                <th>Jenis Masalah Lainnya</th>
                <th>Deskripsi Masalah</th>
                <th>Tanggal</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody>
            {% for laporan in laporan_list %}
            <tr>
                <td>{{ laporan.user.username }}</td>
                <td>{{ laporan.status }}</td>
                <td>{{ laporan.book_title }}</td>
                <td>{{ laporan.issue_type }}</td>
                <td>
                    {% if laporan.issue_type == "Masalah Lainnya" %}
                    {{ laporan.other_issue }}
                    {% endif %}
                </td>
                <td>{{ laporan.description }}</td>
                <td>{{ laporan.date_added|date:"M. d, Y" }}</td>
                <td>
                    <p>{{ laporan.id }}</p>
                    <button class="btn btn-primary response-button" data-id="{{ laporan.id }}">Response</button>
                </td>
            </tr>
            {% empty %}
            {# No reports available, display the message #}
            <tr>
                <td colspan="8">Daftar laporan kosong.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <a class="btn btn-back" href="javascript:history.back();">Back</a>
    <div class="modal" id="responseModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Response Information</h5>
                </div>
                <div class="modal-body">
                    <p>User: <span id="modalUsername"></span></p>
                    <p>Status:
                        {% csrf_token %}
                        <select id="modalStatus" class="input-group">
                            <option value="Review">Review</option>
                            <option value="Accepted">Accepted</option>
                            <option value="Rejected">Rejected</option>
                        </select>
                    </p>
                    <p>Judul Buku: <span id="modalBookTitle"></span></p>
                    <p>Jenis Masalah: <span id="modalIssueType"></span></p>
                    <p>Jenis Masalah Lainnya: <span id="modalOtherIssue"></span></p>
                    <p>Deskripsi Masalah: <span id="modalDescription"></span></p>
                    <p>Tanggal: <span id="modalDate"></span></p>
                    <!-- Formulir Tanggapan -->
                    <form id="responseForm">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="responseTextarea">Tanggapan:</label>
                            <textarea class="form-control" id="responseTextarea" rows="4" name="responseText"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="submitResponseButton">Submit Response</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    //  var csrftoken = $.cookie('csrftoken');

    // function csrfSafeMethod(method) {
    //     // these HTTP methods do not require CSRF protection
    //     return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    // }

    // $.ajaxSetup({
    //     beforeSend: function(xhr, settings) {
    //         if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
    //             xhr.setRequestHeader("X-CSRFToken", csrftoken);
    //         }
    //     }
    // })
    document.addEventListener('DOMContentLoaded', function () {
        var searchInput = document.getElementById('searchByTitle');
        var tableRows = document.querySelectorAll('.table tbody tr');
        searchInput.addEventListener('input', function () {
            var searchTerm = searchInput.value.trim().toLowerCase();
            tableRows.forEach(function (row) {
                var titleCell = row.querySelector('td:nth-child(3)');
                if (titleCell) {
                    var title = titleCell.textContent.trim().toLowerCase();
                    if (title.startsWith(searchTerm)) {
                        row.style.display = 'table-row';
                    } else {
                        row.style.display = 'none';
                    }
                }
            });
        });
        searchInput.addEventListener('input', function () {
            var searchTerm = searchInput.value.trim().toLowerCase();
            if (searchTerm === '') {
                tableRows.forEach(function (row) {
                    row.style.display = 'table-row';
                });
            }
        });
    });
    document.addEventListener('DOMContentLoaded', function () {
        var responseButtons = document.querySelectorAll('.response-button');
        var modalUsername = document.getElementById('modalUsername');
        var modalStatus = document.getElementById('modalStatus');
        var modalBookTitle = document.getElementById('modalBookTitle');
        var modalIssueType = document.getElementById('modalIssueType');
        var modalOtherIssue = document.getElementById('modalOtherIssue');
        var modalDescription = document.getElementById('modalDescription');
        var modalDate = document.getElementById('modalDate');
        responseButtons.forEach(function (button) {
            button.addEventListener('click', function () {
                var reportId = $(this).data('id');
                $('#submitResponseButton').data('report-id', reportId);
                var row = this.closest('tr');
                modalUsername.textContent = row.querySelector('td:nth-child(1)').textContent;
                modalBookTitle.textContent = row.querySelector('td:nth-child(3)').textContent;
                modalIssueType.textContent = row.querySelector('td:nth-child(4)').textContent;
                modalOtherIssue.textContent = row.querySelector('td:nth-child(5)').textContent;
                modalDescription.textContent = row.querySelector('td:nth-child(6)').textContent;
                modalDate.textContent = row.querySelector('td:nth-child(7)').textContent;
                var statusDropdown = document.getElementById('modalStatus');
                var statusCell = row.querySelector('td:nth-child(2)').textContent;
                statusDropdown.value = statusCell;
                $('#responseModal').modal('show');
            });
        });
    });

    $('#submitResponseButton').click(function () {
        var reportId = $(this).data('report-id');
        var responseText = $('#responseTextarea').val();
        var status = $('#modalStatus').val();
        var data = {
            responseText: responseText,
            status: status,
            reportId: reportId
        };

        var url = "{% url 'reportresponse' 0 %}".replace('0', reportId);

        $.ajax({
            url: url,
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            data: JSON.stringify(data),
            success: function (data) {
                console.log('Success function called');
                console.log(data);
                console.log(reportId)
                if (data.success) {
                    $('#responseModal').modal('hide');

                    // Update the table cell values here
                    var tableRow = $(`.table tbody tr[data-id="${reportId}"]`);
                    tableRow.find('td:nth-child(2)').text(data.report.status);  // Update the status
                    tableRow.find('td:nth-child(6)').text(data.report.response_text);  // Update the description

                    // Update the data-id attribute
                    tableRow.attr('data-id', data.report.id);
                    tableRow.hide().show(0);
                }
            },
            error: function (error) {
                console.log('Error function called');
                console.error('AJAX error:', error);
                alert('An error occurred while saving the response.');
            }
        });
    });



</script>
{% endblock content %}
